<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ä»å’Œåœ‹ä¸­ç®¡æ¨‚åœ˜ï½œ114ä¸Šè‡ªä¸»ç·´ç¿’èª¿æŸ¥ï¼ˆå‹•ç•«ç‰ˆ / v4 / GASé©—è­‰ï¼‹å…¨è¢å¹•æˆåŠŸå‹•ç•«ï¼‰</title>
<style>
  :root{
    --primary:#1976d2; --primary-600:#1565c0; --bg:#eaf0ff;
    --danger:#e53935; --muted:#6b7280; --radius:18px;
    --card-minw:320px; --card-maxw:760px; --square-size:300px;
    /* å‹•ç•«æ™‚é–“ï¼ˆå¯èª¿ï¼‰ */
    --reveal-clip:1.10s;      /* æ¨™é¡Œæ“¦å¯«é€Ÿåº¦ */
    --reveal-opacity:.55s;    /* æ¨™é¡Œæ·¡å…¥é€Ÿåº¦ */
  }

  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden; overflow-y:auto;}
html{scrollbar-gutter: stable both-edges;}
  body{
    margin:0; font-family:"Noto Sans TC",system-ui,-apple-system,"Microsoft JhengHei",Arial,sans-serif; color:#1f2937;
    position:relative;
    min-height:100dvh; /* iOS ä¿®æ­£ */
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  body::before{
    content:""; position:fixed; inset:0;
    background:url('background.jpg') center/cover no-repeat;
    filter:saturate(.9) brightness(1.05);
  }
  body::after{ content:""; position:fixed; inset:0; background:rgba(255,255,255,.65); }

  .app{ position:relative; z-index:1; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; padding-inline:clamp(12px,4vw,28px); }

  .card{
    background:#fff; border-radius:var(--radius); box-shadow:0 10px 28px rgba(0,0,0,.12);
    padding:20px; width:100%; max-width:var(--card-maxw); margin-inline:auto;
    transition: width .45s cubic-bezier(.2,0,0,1), height .45s cubic-bezier(.2,0,0,1), border-radius .45s cubic-bezier(.2,0,0,1), box-shadow .3s ease;
    will-change:width,height,border-radius;
    max-height: calc(100dvh - 32px); /* æœ€é«˜ä¸è¶…éè¦–çª— */
    overflow: auto;                  /* è¶…å‡ºæ™‚åœ¨ç™½æ¡†å…§æ²å‹• */
    scrollbar-gutter: stable both-edges; /* é¿å…å‚ç›´å·è»¸å‡ºç¾æ™‚å…§æ–‡åç§»ï¼Œé€ æˆè¦–è¦ºä¸å¹³è¡¡ */
  }

  /* ===== æ¨™é¡Œ / å‰¯æ¨™é¡Œ ===== */
  h1{margin:0 0 6px; text-align:center; font-size:clamp(20px,4vw,28px)}
  .subtitle{ text-align:center; color:var(--muted); margin:0 0 14px }

  /* ===== ç™»å…¥è¡¨å–® ===== */
  #loginForm{ display:flex; flex-direction:column; align-items:center; }
  #loginForm .grid-2{ width:100%; display:flex; justify-content:center; gap:20px; flex-wrap:wrap; }
  #loginForm label{ text-align:center; font-weight:700; font-size:14px; display:block; margin:6px 0; }

  select, input[type=password]{
    width:100%; padding:10px 12px; border:1px solid #cfd8e3; border-radius:12px; background:#fff; outline:none;
    height:44px; line-height:44px; font-weight:400; transition:none;
  }
  select:focus, input[type=password]:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(25,118,210,.15); }
  #classSelect,#name,#password{ width:50%; min-width:260px; margin:0 auto; }
  #loginForm select:disabled{ opacity:1; background:#fff; border-color:#cfd8e3; }

  .actions{display:flex; justify-content:center; gap:12px; margin-top:12px; flex-wrap:wrap}
  .btn{appearance:none; border:0; border-radius:12px; padding:10px 16px; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; min-width:120px; transition:.15s}
  .btn:hover{background:var(--primary-600); transform:translateY(-1px); box-shadow:0 8px 16px rgba(25,118,210,.25)}
  .btn.secondary{background:#e5e7eb; color:#111827}
  .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  .hidden{display:none !important}
  .invisible{visibility:hidden; opacity:0;}
  .fade-out{opacity:0 !important; transition:opacity .25s ease;}
  .error-box{margin-top:10px; background:var(--danger); color:#fff; padding:10px 12px; border-radius:12px; text-align:center; opacity:1; transition:opacity .45s ease;}
  .error-box.fade-out{opacity:.3; }
  .banner{display:flex; align-items:center; gap:10px; background:#eef6ff; border:1px dashed #cfe1ff; color:#29539b; border-radius:12px; padding:10px 12px; margin:10px 0}
  .note{font-size:12px; color:#6b7280; text-align:center; margin-top:10px}

  #prevBox{background:#fff7ed; border:1px solid #fde68a; color:#92400e; border-radius:12px; padding:12px; margin-top:10px}
  #prevBox .title{font-weight:800; margin-bottom:6px}
  #prevBox .time{font-size:12px; color:#92400e}

  .skeleton{height:140px; border-radius:12px; background:linear-gradient(90deg,#eee,#f7f7f7,#eee); background-size:200% 100%; animation:shimmer 1.2s infinite; margin:12px 0;}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .fade-in{opacity:0; transform:translateY(-4px); transition:opacity .24s ease, transform .24s ease;}
  .fade-in.show{opacity:1; transform:none;}
  .fade-only{opacity:0; transition:opacity .24s ease;}
  .fade-only.show{opacity:1;}
  .reveal-clip{opacity:0; clip-path:inset(0 100% 0 0); transition:clip-path var(--reveal-clip) ease, opacity var(--reveal-opacity) ease;}
  .reveal-clip.show{opacity:1; clip-path:inset(0 0 0 0);}

  #bodyWrap{ overflow:hidden; height:0 }

  /* å‹¾é¸å€ï¼šç½®ä¸­ã€ç¸®çŸ­åˆ—å¯¬ */
  #choicesWrap{ text-align:center; margin:36px auto 0; }
  #choicesWrap .checkbox-group{ display:flex; flex-direction:column; gap:10px; align-items:center; }
  #choicesWrap .checkbox-item{
    display:inline-flex; justify-content:center; align-items:center; gap:10px;
    padding:10px 14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    margin:10px auto; min-height:48px;
    min-width:180px; max-width:220px;
  }
  #choicesWrap .checkbox-item label{ font-weight:700; }

  #choicesWrap input[type=checkbox]{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    width:20px; height:20px; border-radius:6px; border:2px solid #111; background:#fff; cursor:pointer; outline:none; transition:none; flex:0 0 20px;
  }
  #choicesWrap input[type=checkbox]:checked{ background:var(--primary); border-color:var(--primary); }
  #choicesWrap input[type=checkbox]:focus{ box-shadow:0 0 0 3px rgba(25,118,210,.15); }

  #fullDone{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center; flex-direction:column; gap:10px;
    background:#fff; z-index:10;
  }
  #fullDone.show{ display:flex; }
  #fullDone h2{ margin:0 0 6px; font-size:clamp(22px,4.5vw,30px); }
  #fullDone img{ width:120px; height:120px;  border-radius:16px; opacity:0; transition:opacity .5s ease; }
  #fullDone img.show{ opacity:1; }

  .fullscreen-mode .app{ transform:none; }

  @media (max-width:480px){
    h1{ font-size:20px; }
    .card{ width:100%; padding:16px; }
    #classSelect,#name,#password{ width:100%; min-width:unset; }
    #btnWrap .btn{ width:100%; min-width:unset; }
    #choicesWrap{ margin-top:28px; }
    #choicesWrap .checkbox-item{ width:min(86vw,320px); min-width:unset; max-width:unset; justify-content:center; }
  }

  @media (prefers-reduced-motion:reduce){
    .card,.fade-in,.fade-only,.reveal-clip{ transition:none !important; }
  }

  #toast{
    position: fixed;
    left: 50%;
    bottom: 24px;
    transform: translateX(-50%) translateY(20px);
    z-index: 9999;
    background: var(--danger);
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,.2);
    opacity: 0;
    pointer-events: none;
    transition: opacity .35s ease, transform .35s ease;
    font-size: 14px;
    text-align: center;
    max-width: min(90vw, 420px);
    white-space: nowrap;
  }
  #toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div id="root" class="">
  <div class="app">
    <!-- ç™»å…¥å¡ -->
    <section id="loginCard" class="card">
      <h1>ä»å’Œåœ‹ä¸­ç®¡æ¨‚åœ˜ï½œ114ä¸Šè‡ªä¸»ç·´ç¿’èª¿æŸ¥</h1>
      <p class="subtitle">è«‹å…ˆé¸æ“‡ç­ç´šèˆ‡å§“åï¼Œå†è¼¸å…¥å¯†ç¢¼ç™»å…¥</p>

      <div id="testBanner" class="banner">
        <span>ğŸ”</span><span><strong>æé†’</strong>ï¼šç³»çµ±æ¶æ§‹å°šæœªå®Œå–„ï¼Œæ¯ä¸€ç­†å¡«å¯«éƒ½æœ‰æ™‚é–“æˆ³è¨˜ç´€éŒ„ï¼Œ<b>åˆ‡å‹¿å¡«å¯«ä»–äººè³‡æ–™</b> </span>
      </div>

      <form id="loginForm">
        <div class="grid-2">
          <div>
            <label for="classSelect">é¸æ“‡ç­ç´š</label>
            <select id="classSelect" required><option value="">è«‹é¸æ“‡</option></select>
          </div>
          <div>
            <label for="name">é¸æ“‡å§“å</label>
            <select id="name" required disabled><option value="">è«‹å…ˆé¸ç­ç´š</option></select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="password">å¯†ç¢¼</label>
          <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼(åŸç­ç´šåº§è™Ÿå…±5ä½)" required/>
        </div>
        <div class="actions">
          <button class="btn" id="btnLogin" type="submit"><span class="btn-text">ç™»å…¥</span></button>
        </div>
        <div id="loginError"></div>
      </form>
    </section>

    <!-- ç¬¬äºŒé  -->
    <section id="formCard" class="card hidden">
      <div class="form-shell">
        <h1 id="welcomeMessage" class="reveal-clip">åŒå­¸ä½ å¥½ï¼è«‹å‹¾é¸æ¬²è‡ªä¸»ç·´ç¿’çš„å¤©æ•¸</h1>

        <div id="prevBox" class="hidden">
          <div class="title" id="prevTitle">å·²æ‰¾åˆ°ä½ ä¸Šæ¬¡é€å‡ºçš„ç´€éŒ„</div>
          <div class="time" id="lastTime"></div>
          <div class="actions" style="margin-top:8px">
            <button id="btnKeep" class="btn secondary" type="button">ä¸ä¿®æ”¹ï¼Œè¿”å›ç™»å…¥</button>
            <button id="btnEdit" class="btn" type="button">æˆ‘è¦ä¿®æ”¹å¾Œé‡æ–°é€å‡º</button>
          </div>
        </div>

        <div id="skeleton" class="skeleton"></div>

        <div id="bodyWrap">
          <form id="responseForm" class="invisible">
            <input type="hidden" id="studentClass" name="ç­ç´š"/>
            <input type="hidden" id="studentName" name="å§“å"/>

            <div class="checkbox-group" id="choicesWrap">
              <div class="checkbox-item"><label for="tue">é€±äºŒ</label><input type="checkbox" id="tue" name="é€±äºŒ" value="âœ“"/></div>
              <div class="checkbox-item"><label for="thu">é€±å››</label><input type="checkbox" id="thu" name="é€±å››" value="âœ“"/></div>
              <div class="checkbox-item"><label for="fri">é€±äº”</label><input type="checkbox" id="fri" name="é€±äº”" value="âœ“"/></div>
            </div>

            <div class="actions" id="btnWrap">
              <button class="btn" id="btnSubmit" type="submit"><span class="btn-text">é€å‡º</span></button>
              <button class="btn secondary" id="btnBack" type="button">è¿”å›ç™»å…¥é é¢</button>
            </div>
          </form>
        </div>
      </div>

      <p id="noteText" class="note fade-only">é€å‡ºå¾Œè‹¥éœ€ä¿®æ”¹ï¼Œå¯é‡æ–°ç™»å…¥é å¡«ä¸¦èª¿æ•´ã€‚<br>æ¯ä½åŒå­¸è‡³å°‘é¸ä¸€å¤©ï¼Œæ——éšŠåŒå­¸é€±å››å¿…é¸ï¼Œä¸”äºŒã€äº”å†æŒ‘ä¸€å¤©</p>
    </section>
  </div>

  <!-- å…¨ç•«é¢æˆåŠŸå±¤ -->
  <div id="fullDone">
    <h2>å¡«å¯«å®Œç•¢ï¼</h2>
    <img id="fullDoneImg" src="success.png" alt="æˆåŠŸåœ–ç¤º"/>
    <div class="actions" style="margin-top:6px">
      <button class="btn secondary" id="btnReturnAfterSuccess" type="button">è¿”å›ç™»å…¥é </button>
    </div>
  </div>
</div>

<script>
/* ===== å¸¸æ•¸è¨­å®š ===== */
const STRICT_LOGIN = true;
const NONEMPTY_AS_PASS = false;
const scriptURL = "https://script.google.com/macros/s/AKfycbwDVnGiRjbuMostKVnov3HLlO6p_c10De1aDbTo7tTLNd-E_knLpI8yGkaIennD1rzv/exec";
let ERR_TIMER = null;

/* åå–® */
const classData = {
  "å…«ç”²": ["å‘‚è‹¡çˆ","å°¤æ¹²ç‹","é»ƒäºå®¶","é­ç´«å¸Œ","é™³å“å¦","é™³èªå½¤","æå˜‰èŒµ","æ—æ¥·å¾¡","æ›¾ç¿å¾·","æ—å¯å–¬","é‚±èºå½¤","å³å¿µç©","å°¤å¿ƒè¾°","è³´éˆºé–","æ—æ­£ä¸€","ææ©ç¶º","éƒ­ç¿æ°","æ—å¯èŒ—","æ¼¢ç¾½å©•","æ±Ÿç¦®è‡»","æå®›éœ","æ—æ„·ç‰¹","è˜‡å­ç‘œ","æ±Ÿç‚˜èŠ³","ç°¡è£´è±","è”¡æ¬£å½¤","åŠ‰å­æš˜"],
  "å…«ä¹™": ["ç°¡å¹¼å–¬","é™³é–é¨","é»ƒæ¢“é´›","å³è–æ©","é™³å¢¨","ç¿è‹¡å®‰","å¼µäºˆæ›¦","æ—æ©æ²›","éƒ­å¥•æ³“","æ—è© å«º","æ›¾æ˜ é”","é„­ç¿è¬™","é‚±å»·æšŸ","é™³å®¶èŠŠ","é™³äºæ¶µ","ç‹å­ç¶­","æèªå©•","æ—æ˜“æ½”","æ›¹å¦˜ç’Ÿ","é»ƒå¦ä¹‹","èŒƒæ­†å¦®","å‘‚å®œè“","é™³å‰ç¥¥","å¾åŒ¯å–¬","é»ƒæ¸¤éˆ","ææ·³é¢¨","é„­æ¥·å¡","èŒƒä¿¡è¾°"],
  "ä¸ƒç”²": ["æ—ç«éˆº","ç‹åŠ­ç¾½","ç‹å“æ¶µ","æœå©•ç‘œ","è”¡æ²›è“‰","é™³æ³«","æ–½æ½”è”“","å¼µå®¶ç‘œ","è‘‰å¯¶æ™´","æå®‰æ™´","å»–å·§å¸Œ","é„­ç¥–å°š","åŠ›å°¹ç¿”","é»ƒæ˜“æ£‹","é™³æ¹˜åº­","è‘‰çš“å®‡","æ—æ·‡è±","ç‹æŸå‡","èƒ¡è‚²é½Š","æ—å­æ™´"],
  "ä¸ƒä¹™": ["è—å©•èª","ç‹å©•èŠ¯","æ—æ€¡è¾°","å¾æ¢“æ™","é‚±æ¦†å®¸","æ›¾å®¥å˜‰","ææ˜•å¦","é‚±è‹¥åº­","é™³å®¥å»·","è©¹æ´§æ™´","é»ƒæ¢“ç·’","å³æŸè«­","å¼µæ©é½Š","é‚±è‹¡æ©","æ›¾ç¿æ˜Œ","è‘‰èŠ¸æ½”","é™³æ¥·å´´","é‚±æ¢“æ™´","æ›¹å¿ƒç‘œ","å®‹ç‘œç‘„"]
};

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const root=$('root');
const loginCard=$('loginCard'), formCard=$('formCard');
const loginForm=$('loginForm'), responseForm=$('responseForm');
const classSel=$('classSelect'), nameSel=$('name'), pw=$('password'), loginError=$('loginError');
const welcome=$('welcomeMessage'), lastTime=$('lastTime'), prevBox=$('prevBox'), prevTitle=$('prevTitle');
const bodyWrap=$('bodyWrap'), skeleton=$('skeleton'), choicesWrap=$('choicesWrap'), btnWrap=$('btnWrap');
const btnKeep=$('btnKeep'), btnEdit=$('btnEdit'), btnBack=$('btnBack');
const btnLogin=$('btnLogin'), btnSubmit=$('btnSubmit');
const noteText=$('noteText');
const fullDone=$('fullDone'), fullDoneImg=$('fullDoneImg');

/* ===== å°å·¥å…· ===== */
function measureTitleWidth(text){
  const probe = document.createElement('span');
  probe.style.cssText = `position:absolute;visibility:hidden;white-space:nowrap;
    font-family:inherit;font-size:clamp(20px,4vw,28px);font-weight:700;left:-9999px;top:-9999px;`;
  probe.textContent = text;
  document.body.appendChild(probe);
  const w = probe.getBoundingClientRect().width;
  document.body.removeChild(probe);
  return w;
}
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }
function onTransitionEnd(el, prop, timeoutMs=1200){
  return new Promise(resolve=>{
    let ended=false;
    const timer=setTimeout(()=>{ if(!ended){ ended=true; resolve(); } }, timeoutMs);
    const handler = e => {
      if(!prop || e.propertyName===prop){
        if(!ended){ ended=true; clearTimeout(timer); }
        el.removeEventListener('transitionend', handler);
        resolve();
      }
    };
    el.addEventListener('transitionend', handler);
  });
}

/* ===== é«˜åº¦æ‹‰ä¼¸å‹•ç•«ï¼ˆåŠ ä¸Šç„¡è®ŠåŒ–å®ˆé–€ / å®‰å…¨è¶…æ™‚ï¼‰ ===== */
function animateHeightToContent(el){
  return new Promise(resolve=>{
    const startH = el.getBoundingClientRect().height;
    el.style.height = 'auto';
    const targetH = el.getBoundingClientRect().height;
    el.style.height = startH + 'px';
    if (Math.abs(targetH - startH) < 1){ el.style.height='auto'; el.style.transition=''; return resolve(); }
    requestAnimationFrame(()=>{
      el.style.transition = 'height .45s cubic-bezier(.2,0,0,1)';
      el.style.height = targetH + 'px';
      const onEnd = (ev)=>{
        if(ev.propertyName==='height'){
          el.style.transition = '';
          el.style.height = 'auto';
          el.removeEventListener('transitionend', onEnd);
          resolve();
        }
      };
      el.addEventListener('transitionend', onEnd);
      setTimeout(()=>{ try{ el.removeEventListener('transitionend', onEnd);}catch(e){} el.style.transition=''; el.style.height='auto'; resolve(); }, 1200);
    });
  });
}

function showError(msg){
  if (ERR_TIMER){ clearTimeout(ERR_TIMER); ERR_TIMER = null; }
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = msg;
  toast.classList.add('show');
  ERR_TIMER = setTimeout(()=>{
    toast.classList.remove('show');
    const onEnd = ()=>{ toast.textContent = ''; toast.removeEventListener('transitionend', onEnd); };
    toast.addEventListener('transitionend', onEnd);
    ERR_TIMER = null;
  }, 2000);
}

/* ===== åˆå§‹åŒ–ç­ç´šä¸‹æ‹‰ ===== */
(function initClasses(){
  Object.keys(classData).sort().forEach(c=>{
    const opt=document.createElement('option'); opt.value=c; opt.textContent=c; classSel.appendChild(opt);
  });
})();

classSel.addEventListener('change', ()=>{
  const cls=classSel.value;
  nameSel.innerHTML='<option value="">è«‹é¸æ“‡</option>';
  nameSel.disabled=!cls;
  if(!cls) return;
  (classData[cls]||[]).forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; nameSel.appendChild(opt);
  });
  pw.value=''; loginError.innerHTML='';
});

/* ===== å‘¼å« GASï¼šç™»å…¥é©—è­‰ ===== */
async function authenticateRemote(cls, name, pass){
  const url = scriptURL
    + '?action=login'
    + '&class=' + encodeURIComponent(cls)
    + '&name='  + encodeURIComponent(name)
    + '&pass='  + encodeURIComponent(pass);
  try{
    const res = await fetch(url, { method:'GET' });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(parseErr){
      console.error('Auth parse error. Raw:', text);
      return { ok:false, message:'GAS å›æ‡‰é JSON' };
    }
    return data;
  }catch(err){
    console.error('Auth fetch error', err);
    return { ok:false, message:'GAS é€£ç·šå¤±æ•—' };
  }
}

/* ===== è¿”å›ç™»å…¥ä¸¦æ¸…ç©º ===== */
function resetToLogin(){
  root.classList.remove('fullscreen-mode');
  fullDone.classList.remove('show');
  fullDoneImg.classList.remove('show');
  formCard.style.position = '';
  formCard.style.left = '';
  formCard.style.top = '';
  formCard.style.width = '';
  formCard.style.height = '';
  formCard.style.margin = '';
  formCard.style.borderRadius = '';
  formCard.style.boxShadow = '';
  formCard.style.transition = '';
  document.querySelector('.form-shell')?.classList.remove('fade-out');
  noteText.classList.remove('fade-out');
  formCard.classList.add('hidden');
  loginCard.classList.remove('hidden');
  classSel.value = "";
  nameSel.innerHTML = '<option value="">è«‹å…ˆé¸ç­ç´š</option>';
  nameSel.disabled = true;
  pw.value = "";
  loginError.innerHTML = "";
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=""; $('studentName').value="";
  prevBox.classList.add('hidden');
  lastTime.textContent = "";
  document.getElementById('responseForm').classList.add('invisible');
  const btnTextEl = btnLogin.querySelector('.btn-text') || btnLogin;
  btnLogin.disabled = false;
  btnTextEl.textContent = 'ç™»å…¥';
}

/* ===== é€²å…¥å¡«å¯«å¡ï¼ˆä¿®æ­£ï¼šè‹¥å¯¬åº¦ä¸è®Šå°±ä¸ç­‰å¾… transitionendï¼‰ ===== */
async function proceed(cls, name){
  loginCard.classList.add('hidden');
  formCard.classList.remove('hidden');

  const titleText = `${name} åŒå­¸ä½ å¥½ï¼è«‹å‹¾é¸æ¬²è‡ªä¸»ç·´ç¿’çš„å¤©æ•¸`;
  const cs = getComputedStyle(formCard);
  const titleWidth = measureTitleWidth(titleText) + (parseInt(cs.paddingLeft)||20) + (parseInt(cs.paddingRight)||20) + (2*parseInt(cs.borderLeftWidth||0)) + 48;
  const maxw = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-maxw')||760);
  const minw = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-minw')||320);
  const targetW = Math.max(Math.min(titleWidth, maxw), minw);
  welcome.textContent = titleText;
  welcome.classList.remove('show');

  const currentW = formCard.getBoundingClientRect().width;
  formCard.style.width = currentW + 'px';
  await nextFrame();
  formCard.style.width = targetW + 'px';
  if (Math.abs(targetW - currentW) >= 1) {
    await onTransitionEnd(formCard, 'width', 1200);
  }

  document.getElementById('welcomeMessage').classList.add('show');

  skeleton.classList.remove('hidden');
  bodyWrap.style.overflow='hidden';
  bodyWrap.style.height = skeleton.offsetHeight + 'px';
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=cls; $('studentName').value=name;
  prevBox.classList.add('hidden');
  responseForm.classList.add('invisible');
  fullDone.classList.remove('show'); fullDoneImg.classList.remove('show');

  let hasPrev=false;
  try{
    const url = scriptURL + '?action=prefill&class=' + encodeURIComponent(cls) + '&name=' + encodeURIComponent(name);
    const res = await fetch(url, {method:'GET'});
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(parseErr){ data = { ok:false }; }
    if(data && data.ok && data.data){
      const rec = data.data;
      const tue = rec['é€±äºŒ']==='âœ“', thu = rec['é€±å››']==='âœ“', fri = rec['é€±äº”']==='âœ“';
      $('tue').checked = tue; $('thu').checked = thu; $('fri').checked = fri;
      const days = []; if(tue) days.push('é€±äºŒ'); if(thu) days.push('é€±å››'); if(fri) days.push('é€±äº”');
      const summary = days.length ? 'ç™»è¨˜çµæœç‚º' + days.join('ã€') : 'ç›®å‰å°šæœªé¸æ“‡';
      prevTitle.textContent = 'å·²æ‰¾åˆ°ä½ ä¸Šæ¬¡é€å‡ºçš„ç´€éŒ„ï¼Œ' + summary;
      lastTime.textContent = rec.timestamp ? ('ä¸Šæ¬¡å¡«å¯«æ™‚é–“ï¼š' + rec.timestamp) : '';
      prevBox.classList.remove('hidden');
      hasPrev = true;
    }
  }catch(e){ console.warn('prefill failed', e); }

  skeleton.classList.add('hidden');
  if(!hasPrev){
    responseForm.classList.remove('invisible');
  }
  await animateHeightToContent(bodyWrap);

  const items = Array.from(document.querySelectorAll('#choicesWrap .checkbox-item'));
  for(let i=0;i<items.length;i++){
    items[i].style.opacity=0; items[i].style.transform='translateY(-4px)';
    setTimeout(()=>{
      items[i].style.transition='opacity .24s ease, transform .24s ease';
      items[i].style.opacity=1; items[i].style.transform='none';
    }, 60*i);
  }
  btnWrap.classList.add('show');
  await nextFrame();
  noteText.classList.add('show');
}

/* ===== äº‹ä»¶ç¶å®š ===== */
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const cls=classSel.value, student=nameSel.value, pass=pw.value;
  if(!cls){ showError('è«‹å…ˆé¸æ“‡ã€Œç­ç´šã€'); return; }
  if(!student){ showError('è«‹å…ˆé¸æ“‡ã€Œå§“åã€'); return; }
  if(!pass){ showError('è«‹è¼¸å…¥å¯†ç¢¼'); return; }

  const loginTextEl = btnLogin.querySelector('.btn-text') || btnLogin;
  const loginTextOld = loginTextEl.textContent;
  btnLogin.disabled = true;
  loginTextEl.textContent = 'ç™»å…¥ä¸­â€¦';

  let allow = false, errMsg = '';
  if(!STRICT_LOGIN){
    allow = true;
  }else if(NONEMPTY_AS_PASS){
    allow = pass.trim().length > 0;
  }else{
    const auth = await authenticateRemote(cls, student, pass);
    allow = !!(auth && auth.ok && auth.matched);
    errMsg = (auth && auth.message) ? auth.message : 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œæˆ–å°šæœªå•Ÿç”¨ã€‚';
  }

  if(allow){
    loginError.innerHTML='';
    await proceed(cls, student);
  }else{
    showError(errMsg);
    btnLogin.disabled = false;
    loginTextEl.textContent = loginTextOld;
  }
});

pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); loginForm.requestSubmit(); } });

btnKeep.addEventListener('click', resetToLogin);
btnEdit.addEventListener('click', async ()=>{
  prevBox.classList.add('hidden');
  responseForm.classList.remove('invisible');
  await animateHeightToContent(bodyWrap);
});
btnBack.addEventListener('click', resetToLogin);
document.getElementById('btnReturnAfterSuccess').addEventListener('click', resetToLogin);

/* ===== æ»¿ç‰ˆæˆåŠŸå‹•ç•« ===== */
async function expandCardToFullscreen(card){
  const rect = card.getBoundingClientRect();
  card.style.position = 'fixed';
  card.style.left = rect.left + 'px';
  card.style.top = rect.top + 'px';
  card.style.width = rect.width + 'px';
  card.style.height = rect.height + 'px';
  card.style.margin = '0';
  await nextFrame();

  const trans = 'left .50s cubic-bezier(.2,0,0,1), top .50s cubic-bezier(.2,0,0,1), width .50s cubic-bezier(.2,0,0,1), height .50s cubic-bezier(.2,0,0,1), border-radius .50s cubic-bezier(.2,0,0,1), box-shadow .30s ease';
  card.style.transition = trans;
  card.style.left = '0';
  card.style.top = '0';
  card.style.width = '100vw';
  card.style.height = '100vh';
  card.style.borderRadius = '0';
  card.style.boxShadow = 'none';

  await onTransitionEnd(card, 'height', 1200);
}

responseForm.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const t=$('tue').checked, h=$('thu').checked, f=$('fri').checked;
  if(!t && !h && !f){ alert('è«‹è‡³å°‘å‹¾é¸ä¸€å¤©ï¼ˆé€±äºŒï¼é€±å››ï¼é€±äº”ï¼‰'); return; }

  const btn = btnSubmit; const txt = btn.querySelector('.btn-text') || btn;
  const old = txt.textContent; btn.disabled=true; txt.textContent='é€å‡ºä¸­â€¦';
  try{
    const fd = new FormData(responseForm);
    const res = await fetch(scriptURL, { method:'POST', body: fd });
    if(!res.ok) throw new Error('network');

    document.querySelector('.form-shell').classList.add('fade-out');
    noteText.classList.add('fade-out');
    await new Promise(r=>setTimeout(r, 260));

    root.classList.add('fullscreen-mode');
    await expandCardToFullscreen(formCard);

    fullDone.classList.add('show');
    requestAnimationFrame(()=> fullDoneImg.classList.add('show'));

  }catch(err){
    alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    btn.disabled=false; txt.textContent=old;
  }
});
</script>

<div id="toast" role="alert" aria-live="polite"></div>

</body>
</html>
