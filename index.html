
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>仁和國中管樂團｜114上自主練習調查（動畫版 / v4 / GAS驗證＋全螢幕成功動畫）</title>
<style>
  :root{
    --primary:#1976d2; --primary-600:#1565c0; --bg:#eaf0ff;
    --danger:#e53935; --muted:#6b7280; --radius:18px;
    --card-minw:320px; --card-maxw:760px; --square-size:300px;
    /* 動畫時間（可調） */
    --reveal-clip:1.10s;      /* 標題擦寫速度 */
    --reveal-opacity:.55s;    /* 標題淡入速度 */
  }

  *{box-sizing:border-box}
  html,body{height:100%; overflow:hidden;}
  body{
    margin:0; font-family:"Noto Sans TC",system-ui,-apple-system,"Microsoft JhengHei",Arial,sans-serif; color:#1f2937;
    position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background:url('background.jpg') center/cover no-repeat;
    filter:saturate(.9) brightness(1.05);
  }
  body::after{ content:""; position:fixed; inset:0; background:rgba(255,255,255,.65); }

  .app{ position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:16px; transform:translateY(-2.5vh); transition:transform .45s cubic-bezier(.2,0,0,1); }

  .card{
    background:#fff; border-radius:var(--radius); box-shadow:0 10px 28px rgba(0,0,0,.12);
    padding:20px; width:min(var(--card-maxw),92vw);
    transition: width .45s cubic-bezier(.2,0,0,1), height .45s cubic-bezier(.2,0,0,1), border-radius .45s cubic-bezier(.2,0,0,1), box-shadow .3s ease;
    will-change:width,height,border-radius;
    max-height: calc(100dvh - 32px); /* 最高不超過視窗，32px 是上下留白可調 */
    overflow: auto;                  /* 超出時在白框內捲動 */
  }

  /* ===== 標題 / 副標題 ===== */
  h1{margin:0 0 6px; text-align:center; font-size:clamp(20px,4vw,28px)}
  .subtitle{ text-align:center; color:var(--muted); margin:0 0 14px } /* 增加與下方距離 */

  /* ===== 登入表單（桌面一半寬，置中；手機滿版） ===== */
  #loginForm{ display:flex; flex-direction:column; align-items:center; }
  #loginForm .grid-2{ width:100%; display:flex; justify-content:center; gap:20px; flex-wrap:wrap; }
  #loginForm label{ text-align:center; font-weight:700; font-size:14px; display:block; margin:6px 0; }

  select, input[type=password]{
    width:100%; padding:10px 12px; border:1px solid #cfd8e3; border-radius:12px; background:#fff; outline:none;
    height:44px; line-height:44px; font-weight:400; transition:none;
  }
  select:focus, input[type=password]:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(25,118,210,.15); }
  #classSelect,#name,#password{ width:50%; min-width:260px; margin:0 auto; }
  #loginForm select:disabled{ opacity:1; background:#fff; border-color:#cfd8e3; }

  .actions{display:flex; justify-content:center; gap:12px; margin-top:12px; flex-wrap:wrap}
  .btn{appearance:none; border:0; border-radius:12px; padding:10px 16px; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; min-width:120px; transition:.15s}
  .btn:hover{background:var(--primary-600); transform:translateY(-1px); box-shadow:0 8px 16px rgba(25,118,210,.25)}
  .btn.secondary{background:#e5e7eb; color:#111827}
  .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  .hidden{display:none !important}
  .invisible{visibility:hidden; opacity:0;}
  .fade-out{opacity:0 !important; transition:opacity .25s ease;}
  .error-box{margin-top:10px; background:var(--danger); color:#fff; padding:10px 12px; border-radius:12px; text-align:center; opacity:1; transition:opacity .45s ease; /* 新增：淡出的動畫時間（可調） */}
  /* 觸發淡出時會套這個 class */
  .error-box.fade-out{opacity:.3; }
  .banner{display:flex; align-items:center; gap:10px; background:#eef6ff; border:1px dashed #cfe1ff; color:#29539b; border-radius:12px; padding:10px 12px; margin:10px 0}
  .note{font-size:12px; color:#6b7280; text-align:center; margin-top:10px} /* 與表單拉開距離 */

  /* ===== 第二頁：內容區 ===== */
  #prevBox{background:#fff7ed; border:1px solid #fde68a; color:#92400e; border-radius:12px; padding:12px; margin-top:10px}
  #prevBox .title{font-weight:800; margin-bottom:6px}
  #prevBox .time{font-size:12px; color:#92400e}

  .skeleton{height:140px; border-radius:12px; background:linear-gradient(90deg,#eee,#f7f7f7,#eee); background-size:200% 100%; animation:shimmer 1.2s infinite; margin:12px 0;}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .fade-in{opacity:0; transform:translateY(-4px); transition:opacity .24s ease, transform .24s ease;}
  .fade-in.show{opacity:1; transform:none;}
  .fade-only{opacity:0; transition:opacity .24s ease;}
  .fade-only.show{opacity:1;}
  .reveal-clip{opacity:0; clip-path:inset(0 100% 0 0); transition:clip-path var(--reveal-clip) ease, opacity var(--reveal-opacity) ease;} /* 可調速 */
  .reveal-clip.show{opacity:1; clip-path:inset(0 0 0 0);}

  #bodyWrap{ overflow:hidden; height:0 }

  /* ===== 勾選區：置中、縮短列寬、與標題拉開距離 ===== */
  #choicesWrap{ text-align:center; margin:36px auto 0; } /* 往下拉開距離 */
  #choicesWrap .checkbox-group{ display:flex; flex-direction:column; gap:10px; align-items:center; }
  #choicesWrap .checkbox-item{
    display:inline-flex; justify-content:center; align-items:center; gap:10px;
    padding:10px 14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    margin:10px auto; min-height:48px;
    min-width:180px; max-width:220px; /* 變短、視覺集中 */
  }
  #choicesWrap .checkbox-item label{ font-weight:700; }

  /* 勾選框：未勾黑框；勾選藍色實心 */
  #choicesWrap input[type=checkbox]{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    width:20px; height:20px; border-radius:6px; border:2px solid #111; background:#fff; cursor:pointer; outline:none; transition:none; flex:0 0 20px;
  }
  #choicesWrap input[type=checkbox]:checked{ background:var(--primary); border-color:var(--primary); }
  #choicesWrap input[type=checkbox]:focus{ box-shadow:0 0 0 3px rgba(25,118,210,.15); }

  /* ===== 全畫面成功畫面 ===== */
  #fullDone{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center; flex-direction:column; gap:10px;
    background:#fff; z-index:10;
  }
  #fullDone.show{ display:flex; }
  #fullDone h2{ margin:0 0 6px; font-size:clamp(22px,4.5vw,30px); }
  #fullDone img{ width:120px; height:120px;  border-radius:16px; opacity:0; transition:opacity .5s ease; }
  #fullDone img.show{ opacity:1; }

  /* 送出動畫時，讓 app 位移歸零，避免邊界露出 */
  .fullscreen-mode .app{ transform:none; }

  /* ===== 手機版 RWD（<=480px） ===== */
  @media (max-width:480px){
    h1{ font-size:20px; }
    .card{ width:95vw; padding:16px; }

    /* 登入表單：滿版、好點擊 */
    #classSelect,#name,#password{ width:100%; min-width:unset; }
    #btnWrap .btn{ width:100%; min-width:unset; }

    /* 勾選列：保持置中，不再左右拉開，避免看起來不對齊 */
    #choicesWrap{ margin-top:28px; }
    #choicesWrap .checkbox-item{
      width:min(86vw,320px);
      min-width:unset; max-width:unset;
      justify-content:center; /* 手機也置中 */
    }
  }

  /* 降低動畫偏好 */
  @media (prefers-reduced-motion:reduce){
    .card,.fade-in,.fade-only,.reveal-clip{ transition:none !important; }
  }

  /* 全局吐司訊息，不佔排版空間 */
  #toast{
    position: fixed;
    left: 50%;
    bottom: 24px;
    transform: translateX(-50%) translateY(20px);
    z-index: 9999;
    background: var(--danger);
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,.2);
    opacity: 0;
    pointer-events: none;        /* 不阻擋點擊 */
    transition: opacity .35s ease, transform .35s ease;
    font-size: 14px;
    text-align: center;
    max-width: min(90vw, 420px);
    white-space: nowrap;
  }
  #toast.show{
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }


</style>
</head>
<body>
<div id="root" class="">
  <div class="app">
    <!-- 登入卡 -->
    <section id="loginCard" class="card">
      <h1>仁和國中管樂團｜114上自主練習調查</h1>
      <p class="subtitle">請先選擇班級與姓名，再輸入密碼登入</p>

      
      <div id="testBanner" class="banner">
        <span>🔐</span><span><strong>提醒</strong>：系統架構尚未完善，每一筆填寫都有時間戳記紀錄，<b>切勿填寫他人資料</b> </span>
      </div>

      <form id="loginForm">
        <div class="grid-2">
          <div>
            <label for="classSelect">選擇班級</label>
            <select id="classSelect" required><option value="">請選擇</option></select>
          </div>
          <div>
            <label for="name">選擇姓名</label>
            <select id="name" required disabled><option value="">請先選班級</option></select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="password">密碼</label>
          <input type="password" id="password" placeholder="請輸入密碼(原班級座號共5位)" required/>
        </div>
        <div class="actions">
          <button class="btn" id="btnLogin" type="submit"><span class="btn-text">登入</span></button>
        </div>
        <div id="loginError"></div>
      </form>
    </section>

    <!-- 第二頁 -->
    <section id="formCard" class="card hidden">
      <div class="form-shell">
        <h1 id="welcomeMessage" class="reveal-clip">同學你好！請勾選欲自主練習的天數</h1>

        <div id="prevBox" class="hidden">
          <div class="title" id="prevTitle">已找到你上次送出的紀錄</div>
          <div class="time" id="lastTime"></div>
          <div class="actions" style="margin-top:8px">
            <button id="btnKeep" class="btn secondary" type="button">不修改，返回登入</button>
            <button id="btnEdit" class="btn" type="button">我要修改後重新送出</button>
          </div>
        </div>

        <div id="skeleton" class="skeleton"></div>

        <div id="bodyWrap">
          <form id="responseForm" class="invisible">
            <input type="hidden" id="studentClass" name="班級"/>
            <input type="hidden" id="studentName" name="姓名"/>

            <div class="checkbox-group" id="choicesWrap">
              <div class="checkbox-item"><label for="tue">週二</label><input type="checkbox" id="tue" name="週二" value="✓"/></div>
              <div class="checkbox-item"><label for="thu">週四</label><input type="checkbox" id="thu" name="週四" value="✓"/></div>
              <div class="checkbox-item"><label for="fri">週五</label><input type="checkbox" id="fri" name="週五" value="✓"/></div>
            </div>

            <div class="actions" id="btnWrap">
              <button class="btn" id="btnSubmit" type="submit"><span class="btn-text">送出</span></button>
              <button class="btn secondary" id="btnBack" type="button">返回登入頁面</button>
            </div>
          </form>
        </div>
      </div>

      <p id="noteText" class="note fade-only">送出後若需修改，可重新登入預填並調整。<br>每位同學至少選一天，旗隊同學週四必選，且二、五再挑一天</p>
    </section>
  </div>

  <!-- 全畫面成功層 -->
  <div id="fullDone">
    <h2>填寫完畢！</h2>
    <img id="fullDoneImg" src="success.png" alt="成功圖示"/>
    <div class="actions" style="margin-top:6px">
      <button class="btn secondary" id="btnReturnAfterSuccess" type="button">返回登入頁</button>
    </div>
  </div>
</div>

<script>
/* ===== 常數設定 ===== */
const STRICT_LOGIN = true;
const NONEMPTY_AS_PASS = false; // 嚴格模式：一定走 GAS 驗證
const scriptURL = "https://script.google.com/macros/s/AKfycbwDVnGiRjbuMostKVnov3HLlO6p_c10De1aDbTo7tTLNd-E_knLpI8yGkaIennD1rzv/exec";
let ERR_TIMER = null;

/* 名單（暫留本地；若要改成 GAS 動態名單，我再幫你接 API） */
const classData = {
  "八甲": ["呂苡珈","尤湲琋","黃于家","魏紫希","陳品妍","陳語彤","李嘉茵","林楷御","曾睿德","林可喬","邱荺彤","吳念穎","尤心辰","賴鈺靖","林正一","李恩綺","郭睿杰","林可茗","漢羽婕","江禮臻","李宛霏","林愷特","蘇子瑜","江炘芳","簡裴萱","蔡欣彤","劉子暘"],
  "八乙": ["簡幼喬","陳靖騏","黃梓鴛","吳聖恩","陳墨","瞿苡安","張予曦","林恩沛","郭奕泓","林詠嫺","曾映達","鄭睿謙","邱廷暟","陳家芊","陳于涵","王子維","李語婕","林易潔","曹妘璟","黃妍之","范歆妮","呂宜蓁","陳偉祥","徐匯喬","黃渤鈞","李淳風","鄭楷叡","范信辰"],
  "七甲": ["林玫鈺","王劭羽","王品涵","杜婕瑜","蔡沛蓉","陳泫","施潔蔓","李安晴","廖巧希","鄭祖尚","力尹翔","黃易棋","陳湘庭","葉皓宇","林淇萱","趙子頡","王柏升","林子晴"],
  "七乙": ["藍婕語","王婕芯","林怡辰","邱榆宸","曾宥嘉","李昕妍","邱若庭","陳宥廷","詹洧晴","黃梓緒","吳柏諭","張恩齊","邱苡恩","曾睿昌","葉芸潔","陳楷崴","邱梓晴","曹心瑜","宋瑜瑄"]
};

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const root=$('root');
const loginCard=$('loginCard'), formCard=$('formCard');
const loginForm=$('loginForm'), responseForm=$('responseForm');
const classSel=$('classSelect'), nameSel=$('name'), pw=$('password'), loginError=$('loginError');
const welcome=$('welcomeMessage'), lastTime=$('lastTime'), prevBox=$('prevBox'), prevTitle=$('prevTitle');
const bodyWrap=$('bodyWrap'), skeleton=$('skeleton'), choicesWrap=$('choicesWrap'), btnWrap=$('btnWrap');
const btnKeep=$('btnKeep'), btnEdit=$('btnEdit'), btnBack=$('btnBack');
const btnLogin=$('btnLogin'), btnSubmit=$('btnSubmit');
const noteText=$('noteText');
const fullDone=$('fullDone'), fullDoneImg=$('fullDoneImg');

/* ===== 小工具：量測標題寬、動畫串接 ===== */
function measureTitleWidth(text){
  const probe = document.createElement('span');
  probe.style.cssText = `position:absolute;visibility:hidden;white-space:nowrap;
    font-family:inherit;font-size:clamp(20px,4vw,28px);font-weight:700;left:-9999px;top:-9999px;`;
  probe.textContent = text;
  document.body.appendChild(probe);
  const w = probe.getBoundingClientRect().width;
  document.body.removeChild(probe);
  return w;
}
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }
function onTransitionEnd(el, prop){
  return new Promise(resolve=>{
    const handler = e => { if(!prop || e.propertyName===prop){ el.removeEventListener('transitionend', handler); resolve(); } };
    el.addEventListener('transitionend', handler);
  });
}

/* ===== 高度拉伸動畫（回傳 Promise） ===== */
function animateHeightToContent(el){
  return new Promise(resolve=>{
    const startH = el.getBoundingClientRect().height;
    el.style.height = 'auto';
    const targetH = el.getBoundingClientRect().height;
    el.style.height = startH + 'px';
    requestAnimationFrame(()=>{
      el.style.transition = 'height .45s cubic-bezier(.2,0,0,1)';
      el.style.height = targetH + 'px';
      const onEnd = (ev)=>{
        if(ev.propertyName==='height'){
          el.style.transition = '';
          el.style.height = 'auto';
          el.removeEventListener('transitionend', onEnd);
          resolve();
        }
      };
      el.addEventListener('transitionend', onEnd);
    });
  });
}

function showError(msg){
  // 清掉前一次排程
  if (ERR_TIMER){ clearTimeout(ERR_TIMER); ERR_TIMER = null; }

  // 顯示 toast
  const toast = document.getElementById('toast');
  if (!toast) return; // 保護：沒加容器就直接離開
  toast.textContent = msg;
  toast.classList.add('show');

  // 2 秒後開始淡出；動畫 .35s 結束後關閉
  ERR_TIMER = setTimeout(()=>{
    toast.classList.remove('show');
    // 等 CSS transition 結束再清掉文字（避免閃爍）
    const onEnd = ()=>{ toast.textContent = ''; toast.removeEventListener('transitionend', onEnd); };
    toast.addEventListener('transitionend', onEnd);
    ERR_TIMER = null;
  }, 2000);
}



/* ===== 初始化班級下拉 ===== */
(function initClasses(){
  Object.keys(classData).sort().forEach(c=>{
    const opt=document.createElement('option'); opt.value=c; opt.textContent=c; classSel.appendChild(opt);
  });
})();

classSel.addEventListener('change', ()=>{
  const cls=classSel.value;
  nameSel.innerHTML='<option value="">請選擇</option>';
  nameSel.disabled=!cls;
  if(!cls) return;
  (classData[cls]||[]).forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; nameSel.appendChild(opt);
  });
  pw.value=''; loginError.innerHTML='';
});

/* ===== 呼叫 GAS：登入驗證 ===== */
async function authenticateRemote(cls, name, pass){
  const url = scriptURL
    + '?action=login'
    + '&class=' + encodeURIComponent(cls)
    + '&name='  + encodeURIComponent(name)
    + '&pass='  + encodeURIComponent(pass);
  try{
    const res = await fetch(url, { method:'GET' });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(parseErr){
      console.error('Auth parse error. Raw:', text);
      return { ok:false, message:'GAS 回應非 JSON' };
    }
    return data;
  }catch(err){
    console.error('Auth fetch error', err);
    return { ok:false, message:'GAS 連線失敗' };
  }
}

/* ===== 返回登入並清空 ===== */
function resetToLogin(){
  // 復原全螢幕狀態
  root.classList.remove('fullscreen-mode');
  fullDone.classList.remove('show');
  fullDoneImg.classList.remove('show');
  // 清除卡片因滿版設定過的內聯樣式
  formCard.style.position = '';
  formCard.style.left = '';
  formCard.style.top = '';
  formCard.style.width = '';
  formCard.style.height = '';
  formCard.style.margin = '';
  formCard.style.borderRadius = '';
  formCard.style.boxShadow = '';
  formCard.style.transition = '';
  // 內容復原
  document.querySelector('.form-shell')?.classList.remove('fade-out');
  noteText.classList.remove('fade-out');
  // 切頁
  formCard.classList.add('hidden');
  loginCard.classList.remove('hidden');
  // 清表單
  classSel.value = "";
  nameSel.innerHTML = '<option value="">請先選班級</option>';
  nameSel.disabled = true;
  pw.value = "";
  loginError.innerHTML = "";
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=""; $('studentName').value="";
  prevBox.classList.add('hidden');
  lastTime.textContent = "";
  document.getElementById('responseForm').classList.add('invisible');
  // 登入按鈕恢復可點與文字
  const btnTextEl = btnLogin.querySelector('.btn-text') || btnLogin;
  btnLogin.disabled = false;
  btnTextEl.textContent = '登入';
}

/* ===== 進入填寫卡並載入資料（含動畫流程） ===== */
async function proceed(cls, name){
  // 切頁
  loginCard.classList.add('hidden');
  formCard.classList.remove('hidden');

  // 階段 A-1：白框收窄到可容納標題
  const titleText = `${name} 同學你好！請勾選欲自主練習的天數`;
  const titleWidth = measureTitleWidth(titleText) + (parseInt(getComputedStyle(formCard).paddingLeft)||20) + (parseInt(getComputedStyle(formCard).paddingRight)||20) + (2*parseInt(getComputedStyle(formCard).borderLeftWidth||0)) + 48;
  const targetW = Math.max(Math.min(titleWidth, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-maxw')||760)), parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-minw')||320));
  welcome.textContent = titleText;
  welcome.classList.remove('show');
  formCard.style.width = formCard.getBoundingClientRect().width + 'px'; // 鎖當前寬
  await nextFrame();
  formCard.style.width = targetW + 'px';      // 收窄
  await onTransitionEnd(formCard, 'width');

  // 階段 A-2：標題擦入（速度由 --reveal-clip / --reveal-opacity 控制）
  document.getElementById('welcomeMessage').classList.add('show');

  // 骨架開啟 + 預設狀態
  skeleton.classList.remove('hidden');
  document.getElementById('bodyWrap').style.overflow='hidden';
  document.getElementById('bodyWrap').style.height = skeleton.offsetHeight + 'px';
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=cls; $('studentName').value=name;
  prevBox.classList.add('hidden');
  document.getElementById('responseForm').classList.add('invisible');
  fullDone.classList.remove('show'); fullDoneImg.classList.remove('show');

  // 查詢歷史（改用 action=prefill）
  let hasPrev=false;
  try{
    const url = scriptURL + '?action=prefill&class=' + encodeURIComponent(cls) + '&name=' + encodeURIComponent(name);
    const res = await fetch(url, {method:'GET'});
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(parseErr){ data = { ok:false }; }
    if(data && data.ok && data.data){
      const rec = data.data;
      const tue = rec['週二']==='✓', thu = rec['週四']==='✓', fri = rec['週五']==='✓';
      $('tue').checked = tue; $('thu').checked = thu; $('fri').checked = fri;
      const days = []; if(tue) days.push('週二'); if(thu) days.push('週四'); if(fri) days.push('週五');
      const summary = days.length ? '登記結果為' + days.join('、') : '目前尚未選擇';
      prevTitle.textContent = '已找到你上次送出的紀錄，' + summary;
      lastTime.textContent = rec.timestamp ? ('上次填寫時間：' + rec.timestamp) : '';
      prevBox.classList.remove('hidden');
      hasPrev = true;
    }
  }catch(e){ console.warn('prefill failed', e); }

  // 階段 B：白框展開到內容高度，並階梯淡入
  skeleton.classList.add('hidden');
  if(!hasPrev){
    document.getElementById('responseForm').classList.remove('invisible');
    choicesWrap.classList.remove('show'); btnWrap.classList.remove('show');
  }
  await animateHeightToContent(document.getElementById('bodyWrap'));

  // 淡入顯示（含小字）
  const items = Array.from(document.querySelectorAll('#choicesWrap .checkbox-item'));
  for(let i=0;i<items.length;i++){
    items[i].style.opacity=0; items[i].style.transform='translateY(-4px)';
    setTimeout(()=>{
      items[i].style.transition='opacity .24s ease, transform .24s ease';
      items[i].style.opacity=1; items[i].style.transform='none';
    }, 60*i);
  }
  btnWrap.classList.add('show');
  await nextFrame();
  document.getElementById('noteText').classList.add('show');
}

/* ===== 事件綁定 ===== */
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const cls=classSel.value, student=nameSel.value, pass=pw.value;
  if(!cls){ showError('請先選擇「班級」'); return; }
  if(!student){ showError('請先選擇「姓名」'); return; }
  if(!pass){ showError('請輸入密碼'); return; }

  // 1) 按下登入 → 按鈕變淡 & 禁用
  const loginTextEl = btnLogin.querySelector('.btn-text') || btnLogin;
  const loginTextOld = loginTextEl.textContent;
  btnLogin.disabled = true;
  loginTextEl.textContent = '登入中…';

  // 2) 驗證
  let allow = false, errMsg = '';
  if(!STRICT_LOGIN){
    allow = true;
  }else if(NONEMPTY_AS_PASS){
    allow = pass.trim().length > 0;
  }else{
    const auth = await authenticateRemote(cls, student, pass);
    allow = !!(auth && auth.ok && auth.matched);
    errMsg = (auth && auth.message) ? auth.message : '帳號或密碼錯誤，或尚未啟用。';
  }

  // 3) 結果
  if(allow){
    loginError.innerHTML='';
    await proceed(cls, student);
    // 成功時不需立刻解鎖按鈕（避免連點重送）
  }else{
    showError(errMsg);
    btnLogin.disabled = false;
    loginTextEl.textContent = loginTextOld;
  }
});

// Enter 於密碼欄可直接送出
pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); loginForm.requestSubmit(); } });

// 不修改 → 返回登入
btnKeep.addEventListener('click', resetToLogin);
// 我要修改 → 顯示表單並拉伸
btnEdit.addEventListener('click', async ()=>{
  prevBox.classList.add('hidden');
  document.getElementById('responseForm').classList.remove('invisible');
  await animateHeightToContent(document.getElementById('bodyWrap'));
});
btnBack.addEventListener('click', resetToLogin);
document.getElementById('btnReturnAfterSuccess').addEventListener('click', resetToLogin);

// 讓卡片用 FLIP 方式平滑擴張成全螢幕
async function expandCardToFullscreen(card){
  // 記錄目前位置/尺寸
  const rect = card.getBoundingClientRect();

  // 固定卡片到視窗座標，避免跳動
  card.style.position = 'fixed';
  card.style.left = rect.left + 'px';
  card.style.top = rect.top + 'px';
  card.style.width = rect.width + 'px';
  card.style.height = rect.height + 'px';
  card.style.margin = '0';
  await nextFrame();

  // 補間到滿版
  const trans = 'left .50s cubic-bezier(.2,0,0,1), top .50s cubic-bezier(.2,0,0,1), width .50s cubic-bezier(.2,0,0,1), height .50s cubic-bezier(.2,0,0,1), border-radius .50s cubic-bezier(.2,0,0,1), box-shadow .30s ease';
  card.style.transition = trans;
  card.style.left = '0';
  card.style.top = '0';
  card.style.width = '100vw';
  card.style.height = '100vh';
  card.style.borderRadius = '0';
  card.style.boxShadow = 'none';

  // 等尺寸動畫完成
  await onTransitionEnd(card, 'height');
}


/* ===== 送出（全螢幕成功動畫版） ===== */
responseForm.addEventListener('submit', async (e)=>{
  e.preventDefault();

  // 至少勾一個
  const t=$('tue').checked, h=$('thu').checked, f=$('fri').checked;
  if(!t && !h && !f){ alert('請至少勾選一天（週二／週四／週五）'); return; }

  const btn = btnSubmit; const txt = btn.querySelector('.btn-text') || btn;
  const old = txt.textContent; btn.disabled=true; txt.textContent='送出中…';
  try{
    const fd = new FormData(responseForm);
    const res = await fetch(scriptURL, { method:'POST', body: fd });
    if(!res.ok) throw new Error('network');

    // STEP 1：白框內所有東西淡出
    document.querySelector('.form-shell').classList.add('fade-out');
    document.getElementById('noteText').classList.add('fade-out');
    await new Promise(r=>setTimeout(r, 260)); // 等淡出

    // STEP 2：白框擴張填滿整個頁面（使整頁變白）
    root.classList.add('fullscreen-mode');
    await expandCardToFullscreen(formCard);

    // STEP 3：顯示全畫面成功層
    fullDone.classList.add('show');
    requestAnimationFrame(()=> fullDoneImg.classList.add('show'));

  }catch(err){
    alert('送出失敗，請稍後再試');
  }finally{
    btn.disabled=false; txt.textContent=old;
  }
});
</script>

<div id="toast" role="alert" aria-live="polite"></div>

</body>
</html>
