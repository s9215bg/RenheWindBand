<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ä»å’Œåœ‹ä¸­ç®¡æ¨‚åœ˜ï½œè‡ªä¸»ç·´ç¿’èª¿æŸ¥ï¼ˆå‹•ç•«ç‰ˆï¼‰</title>
<style>
  :root{
    --primary:#1976d2; --primary-600:#1565c0; --bg:#eaf0ff;
    --danger:#e53935; --muted:#6b7280; --radius:18px;
    --card-minw: 320px;          /* ç™½æ¡†æœ€å°å¯¬ */
    --card-maxw: 760px;          /* ç™½æ¡†æœ€å¤§å¯¬ï¼ˆåŸæœ¬å¯¬ï¼‰*/
    --card-pad-x: 20px;          /* å·¦å³ paddingï¼Œä¾›å¯¬åº¦ä¼°ç®— */
    --title-safe: 24px;          /* æ¨™é¡Œå·¦å³å®‰å…¨é‚Šç•Œ */
    --square-size: 300px;        /* æˆåŠŸæ™‚ç™½æ¡†æ­£æ–¹å½¢é‚Šé•· */
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow:hidden;}
  body{
    margin:0; font-family:"Noto Sans TC",system-ui,-apple-system,"Microsoft JhengHei",Arial,sans-serif; color:#1f2937;
    position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background:url('background.jpg') center/cover no-repeat;
    filter:saturate(0.9) brightness(1.05);
  }
  body::after{
    content:""; position:fixed; inset:0; background:rgba(255,255,255,.65);
  }
  .app{ position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:16px; transform: translateY(-2.5vh);}
  .card{
    background:#fff; border-radius:var(--radius); box-shadow:0 10px 28px rgba(0,0,0,.12);
    padding:20px; width:min(var(--card-maxw),92vw);
    transition: width .35s cubic-bezier(.2,0,0,1), height .45s cubic-bezier(.2,0,0,1);
    will-change: width, height;
    overflow:hidden;  /* è®“æ“¦å…¥/æ·¡å…¥ä¸æº¢å‡º */
  }
  h1{margin:0 0 6px; text-align:center; font-size:clamp(20px,4vw,28px)}
  .subtitle{text-align:center; color:var(--muted); margin:0 0 8px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:520px){.grid-2{grid-template-columns:1fr}}
  label{font-weight:700; font-size:14px; margin:6px 0; display:block}
  select,input[type=password]{width:100%; padding:10px 12px; border:1px solid #cfd8e3; border-radius:12px; background:#fff; outline:none}
  select:focus,input[type=password]:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(25,118,210,.15)}
  .actions{display:flex; justify-content:center; gap:12px; margin-top:12px; flex-wrap:wrap}
  .btn{appearance:none; border:0; border-radius:12px; padding:10px 16px; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; min-width:120px; transition:.15s}
  .btn:hover{background:var(--primary-600); transform:translateY(-1px); box-shadow:0 8px 16px rgba(25,118,210,.25)}
  .btn.secondary{background:#e5e7eb; color:#111827}
  .hidden{display:none !important}
  .invisible{visibility:hidden; opacity:0;}
  .error-box{margin-top:10px; background:var(--danger); color:#fff; padding:10px 12px; border-radius:12px; text-align:center}
  .banner{display:flex; align-items:center; gap:10px; background:#eef6ff; border:1px dashed #cfe1ff; color:#29539b; border-radius:12px; padding:10px 12px; margin:10px 0}

  .note{font-size:12px; color:#6b7280; text-align:center; margin-top:8px}
  #prevBox{background:#fff7ed; border:1px solid #fde68a; color:#92400e; border-radius:12px; padding:12px; margin-top:10px}
  #prevBox .title{font-weight:800; margin-bottom:6px}
  #prevBox .time{font-size:12px; color:#92400e}

  /* éª¨æ¶ */
  .skeleton{height:140px; border-radius:12px; background:linear-gradient(90deg,#eee,#f7f7f7,#eee); background-size:200% 100%; animation:shimmer 1.2s infinite; margin:8px 0;}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* ç¬¬äºŒé ï¼šæ’ç‰ˆèˆ‡å‹•ç•«æ”¯æ´ */
  .fade-in{opacity:0; transform:translateY(-4px); transition:opacity .24s ease, transform .24s ease;}
  .fade-in.show{opacity:1; transform:none;}
  .fade-only{opacity:0; transition:opacity .24s ease;}
  .fade-only.show{opacity:1;}

  /* æ¨™é¡Œæ“¦å…¥ï¼ˆç”±å·¦è‡³å³ï¼‰ */
  .reveal-clip{
    opacity:0;
    clip-path: inset(0 100% 0 0);
    transition: clip-path .30s ease, opacity .30s ease;
  }
  .reveal-clip.show{
    opacity:1;
    clip-path: inset(0 0 0 0);
  }

  /* é¸é …å€å¡Šå¤–æ¡†ï¼šå¯¬åº¦ç¸®å°ã€å’Œæ¨™é¡Œæ‹‰é–‹è·é›¢ */
  #choicesWrap {
    text-align: center;           /* çˆ¶å±¤æ–‡å­—ç½®ä¸­ */
  }
  .checkbox-group{ display:flex; flex-direction:column; gap:10px; align-items:stretch; margin-top:8px }
  /* å–®ä¸€é¸é …ï¼šæ–‡å­— + å‹¾é¸æ¡†ç½®ä¸­ */
  #choicesWrap .checkbox-item {
    display: inline-flex;
    justify-content: center;   /* æ°´å¹³ç½®ä¸­ */
    align-items: center;       /* å‚ç›´ç½®ä¸­ */
    gap: 10px;                 /* æ–‡å­—å’Œå‹¾é¸æ¡†çš„è·é›¢ï¼ˆå¯è‡ªè¡Œèª¿å°/å¤§ï¼‰ */
    padding: 10px 16px;        /* å…§è·èˆ’é©ä¸€äº› */
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
  }
  .checkbox-item:hover{ box-shadow:0 6px 14px rgba(0,0,0,.06); transform: translateY(-1px); }
  .checkbox-item label{ margin:0; font-weight:800; }

  /* è‡ªè¨‚ checkboxï¼šæœªå‹¾ç´°é»‘æ¡†ï¼å‹¾é¸è—è‰²å¯¦å¿ƒ */
  #choicesWrap input[type=checkbox]{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    width:22px; height:22px; border-radius:6px;
    border:2px solid #111; background:#fff; cursor:pointer; outline:none;
    transition:none; /* é¿å…å°ºå¯¸/é‚Šæ¡†å‹•ç•«é€ æˆã€Œè·³å‹•ã€éŒ¯è¦º */
    flex:0 0 22px;
  }
  #choicesWrap input[type=checkbox]:checked{
    background: var(--primary);
    border-color: var(--primary);
  }
  #choicesWrap input[type=checkbox]:focus{
    box-shadow: 0 0 0 3px rgba(25,118,210,.15);
  }

  /* ç¬¬äºŒé å®¹å™¨æ§é«˜ï¼ˆäº¤çµ¦ JS æ‹‰ä¼¸ï¼‰ */
  #bodyWrap{ overflow:hidden; height:0 }

  /* æˆåŠŸå€å¡Š */
  .success{display:flex; flex-direction:column; align-items:center; gap:8px; padding:16px}
  .success img{width:110px; height:110px; opacity:0; transition:opacity .5s ease;}
  .success img.show{opacity:1;}

  /* ç™»å…¥æ¬„ä½ï¼šç½®ä¸­ + åŠå¯¬ + é˜²è·³å‹• */
  #loginForm{ display:flex; flex-direction:column; align-items:center; }
  #loginForm .grid-2{ width:100%; display:flex; justify-content:center; gap:20px; }
  #loginForm label{ text-align:center; display:block; }
  #classSelect,#name,#password{ width:50%; min-width:260px; height:44px; line-height:44px; margin:0 auto; box-sizing:border-box; font-weight:400; transition:none; }
  #loginForm select:disabled{ opacity:1; background:#fff; border-color:#cfd8e3; }

  @media (prefers-reduced-motion: reduce){
    .card{ transition:none !important; }
    .fade-in,.fade-only,.reveal-clip{ transition:none !important; }
  }

  /* è®“æ–‡å­—èˆ‡å‹¾é¸é è¿‘ + ç¸®å°æ¯åˆ—å¯¬åº¦ */
  #choicesWrap { 
    width: min(460px, 92%);   /* åŸæœ¬ 520pxï¼Œæ”¹å°è®“å·¦å³è·é›¢è‡ªç„¶è®Šè¿‘ */
    margin: 0 auto;
  }
  #choicesWrap .checkbox-item{
    justify-content: flex-start; /* ä¸è¦å…©ç«¯å°é½Šï¼Œæ”¹æˆé è¿‘æ’åˆ— */
    gap: 100px;                   /* æ–‡å­—èˆ‡å‹¾é¸ä¹‹é–“ç•™ 12px é–“è· */
  }

  /* è®“æŒ‰éˆ•ç¾¤å†å¾€ä¸‹ */
  #btnWrap{
    margin-top: 24px;   /* æƒ³æ›´ä¸‹å°±è¨­ 28pxã€32px */
  }
  
</style>
</head>
<body>
<div class="app">
  <!-- ç™»å…¥å¡ -->
  <section id="loginCard" class="card">
    <h1>ä»å’Œåœ‹ä¸­ç®¡æ¨‚åœ˜ï½œè‡ªä¸»ç·´ç¿’èª¿æŸ¥</h1>
    <p class="subtitle">è«‹å…ˆé¸æ“‡ç­ç´šèˆ‡å§“åï¼Œå†è¼¸å…¥å¯†ç¢¼ç™»å…¥</p>
    <div id="testBanner" class="banner">
      <span>ğŸ§ª</span><span><strong>æ¸¬è©¦å¯†ç¢¼è¦å‰‡</strong>ï¼šç›®å‰ã€Œåš´æ ¼æ¨¡å¼ã€é–‹å•Ÿï¼Œä½†å…ˆæ¡ <b>éç©ºå³å¯</b>ï¼ˆæ—¥å¾Œå¯æ›æˆçœŸå¯¦æ¯”å°ï¼‰ã€‚</span>
    </div>
    <form id="loginForm">
      <div class="grid-2">
        <div>
          <label for="classSelect">é¸æ“‡ç­ç´š</label>
          <select id="classSelect" required><option value="">è«‹é¸æ“‡</option></select>
        </div>
        <div>
          <label for="name">é¸æ“‡å§“å</label>
          <select id="name" required disabled><option value="">è«‹å…ˆé¸ç­ç´š</option></select>
        </div>
      </div>
      <div style="margin-top:12px">
        <label for="password">å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="ç›®å‰æ¸¬è©¦ï¼šéç©ºå³å¯" required/>
      </div>
      <div class="actions">
        <button class="btn" id="btnLogin" type="submit">ç™»å…¥</button>
      </div>
      <div id="loginError"></div>
    </form>
  </section>

  <!-- ç¬¬äºŒé  -->
  <section id="formCard" class="card hidden">
    <div class="form-shell">
      <h1 id="welcomeMessage" class="reveal-clip">åŒå­¸ä½ å¥½ï¼è«‹å‹¾é¸æ¬²è‡ªä¸»ç·´ç¿’çš„å¤©æ•¸</h1>

      <div id="prevBox" class="hidden">
        <div class="title" id="prevTitle">å·²æ‰¾åˆ°ä½ ä¸Šæ¬¡é€å‡ºçš„ç´€éŒ„</div>
        <div class="time" id="lastTime"></div>
        <div class="actions" style="margin-top:8px">
          <button id="btnKeep" class="btn secondary" type="button">ä¸ä¿®æ”¹ï¼Œè¿”å›ç™»å…¥</button>
          <button id="btnEdit" class="btn" type="button">æˆ‘è¦ä¿®æ”¹å¾Œé‡æ–°é€å‡º</button>
        </div>
      </div>

      <div id="skeleton" class="skeleton"></div>

      <div id="bodyWrap">
        <form id="responseForm" class="invisible">
          <input type="hidden" id="studentClass" name="ç­ç´š"/>
          <input type="hidden" id="studentName" name="å§“å"/>

          <div class="checkbox-group" id="choicesWrap">
            <div class="checkbox-item"><label for="tue">é€±äºŒ</label><input type="checkbox" id="tue" name="é€±äºŒ" value="âœ“"/></div>
            <div class="checkbox-item"><label for="thu">é€±å››</label><input type="checkbox" id="thu" name="é€±å››" value="âœ“"/></div>
            <div class="checkbox-item"><label for="fri">é€±äº”</label><input type="checkbox" id="fri" name="é€±äº”" value="âœ“"/></div>
          </div>

          <div class="actions" id="btnWrap">
            <button class="btn" id="btnSubmit" type="submit"><span class="btn-text">é€å‡º</span></button>
            <button class="btn secondary" id="btnBack" type="button">è¿”å›ç™»å…¥é é¢</button>
          </div>
        </form>

        <div id="successBox" class="hidden">
          <div class="success">
            <div id="successTitle" style="font-weight:800; text-align:center;">é€å‡ºæˆåŠŸ</div>
            <img id="successImg" src="success.png" alt="æˆåŠŸåœ–ç¤º"/>
            <div class="actions" style="margin-top:6px">
              <button class="btn secondary" id="btnReturnAfterSuccess" type="button">è¿”å›ç™»å…¥é é¢</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p id="noteText" class="note fade-only">é€å‡ºå¾Œè‹¥éœ€ä¿®æ”¹ï¼Œå¯é‡æ–°ç™»å…¥é å¡«ä¸¦èª¿æ•´ã€‚</p>
  </section>
</div>

<script>
/* ===== å¸¸æ•¸è¨­å®š ===== */
const STRICT_LOGIN = true;
const NONEMPTY_AS_PASS = true;
const scriptURL = "https://script.google.com/macros/s/AKfycby0ruEwUstZYs8bqtRYOdY6ySi6D26NyBwSRKPOIB2Kq4xXVFdTxHYWqPTG1L0m27-M/exec";

/* åå–® */
const classData = {
  "å…«(22)ç”²": ["å‘‚è‹¡çˆ","å°¤æ¹²ç‹","é»ƒäºå®¶","é­ç´«å¸Œ","é™³å“å¦","é™³èªå½¤","æå˜‰èŒµ","æ—æ¥·å¾¡","æ›¾ç¿å¾·","æ—å¯å–¬","é‚±èºå½¤","å³å¿µç©","å°¤å¿ƒè¾°","è³´éˆºé–","æ—æ­£ä¸€","ææ©ç¶º","éƒ­ç¿æ°","æ—å¯èŒ—","æ¼¢ç¾½å©•","æ±Ÿç¦®è‡»","æå®›éœ","æ—æ„·ç‰¹","è˜‡å­ç‘œ","æ±Ÿç‚˜èŠ³","ç°¡è£´è±","è”¡æ¬£å½¤","åŠ‰å­æš˜"],
  "å…«(22)ä¹™": ["ç°¡å¹¼å–¬","é™³é–é¨","é»ƒæ¢“é´›","å³è–æ©","é™³å¢¨","ç¿è‹¡å®‰","å¼µäºˆæ›¦","æ—æ©æ²›","éƒ­å¥•æ³“","æ—è© å«º","æ›¾æ˜ é”","é„­ç¿è¬™","é‚±å»·æšŸ","é™³å®¶èŠŠ","é™³äºæ¶µ","ç‹å­ç¶­","æèªå©•","æ—æ˜“æ½”","æ›¹å¦˜ç’Ÿ","é»ƒå¦ä¹‹","èŒƒæ­†å¦®","å‘‚å®œè“","é™³å‰ç¥¥","å¾åŒ¯å–¬","é»ƒæ¸¤éˆ","ææ·³é¢¨","é„­æ¥·å¡","èŒƒä¿¡è¾°"],
  "ä¸ƒ(23)ç”²": ["æ—ç«éˆº","ç‹åŠ­ç¾½","ç‹å“æ¶µ","æœå©•ç‘œ","è”¡æ²›è“‰","é™³æ³«","æ–½æ½”è”“","æå®‰æ™´","å»–å·§å¸Œ","é„­ç¥–å°š","åŠ›å°¹ç¿”","é»ƒæ˜“æ£‹","é™³æ¹˜åº­","è‘‰çš“å®‡","æ—æ·‡è±","è¶™å­é ¡","ç‹æŸå‡","æ—å­æ™´"],
  "ä¸ƒ(23)ä¹™": ["è—å©•èª","ç‹å©•èŠ¯","æ—æ€¡è¾°","é‚±æ¦†å®¸","æ›¾å®¥å˜‰","ææ˜•å¦","é‚±è‹¥åº­","é™³å®¥å»·","è©¹æ´§æ™´","é»ƒæ¢“ç·’","å³æŸè«­","å¼µæ©é½Š","é‚±è‹¡æ©","æ›¾ç¿æ˜Œ","è‘‰èŠ¸æ½”","é™³æ¥·å´´","é‚±æ¢“æ™´","æ›¹å¿ƒç‘œ","å®‹ç‘œç‘„"]
};

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const loginCard=$('loginCard'), formCard=$('formCard');
const loginForm=$('loginForm'), responseForm=$('responseForm'), successBox=$('successBox');
const classSel=$('classSelect'), nameSel=$('name'), pw=$('password'), loginError=$('loginError');
const welcome=$('welcomeMessage'), lastTime=$('lastTime'), prevBox=$('prevBox'), prevTitle=$('prevTitle');
const bodyWrap=$('bodyWrap'), skeleton=$('skeleton'), choicesWrap=$('choicesWrap'), btnWrap=$('btnWrap');
const btnKeep=$('btnKeep'), btnEdit=$('btnEdit'), btnBack=$('btnBack'), btnReturnAfterSuccess=$('btnReturnAfterSuccess');
const noteText=$('noteText'), successImg=$('successImg');

/* ===== å°å·¥å…·ï¼šé‡æ¸¬æ¨™é¡Œå¯¬ã€å‹•ç•«ä¸²æ¥ ===== */
function measureTitleWidth(text){
  // å»ºç«‹ä¸€æ¬¡æ€§é‡æ¸¬å…ƒç´ 
  const probe = document.createElement('span');
  probe.style.cssText = `
    position: absolute; visibility: hidden; white-space: nowrap;
    font-family: inherit; font-size: clamp(20px,4vw,28px); font-weight: 700;
    left:-9999px; top:-9999px;
  `;
  probe.textContent = text;
  document.body.appendChild(probe);
  const w = probe.getBoundingClientRect().width;
  document.body.removeChild(probe);
  return w;
}
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }
function onTransitionEnd(el, prop){
  return new Promise(resolve=>{
    const handler = e => { if(!prop || e.propertyName===prop){ el.removeEventListener('transitionend', handler); resolve(); } };
    el.addEventListener('transitionend', handler);
  });
}

/* ===== é«˜åº¦æ‹‰ä¼¸å‹•ç•«ï¼ˆæ²¿ç”¨ï¼Œä½†å›å‚³ Promiseï¼‰ ===== */
function animateHeightToContent(el){
  return new Promise(resolve=>{
    const startH = el.getBoundingClientRect().height;
    el.style.height = 'auto';
    const targetH = el.getBoundingClientRect().height;
    el.style.height = startH + 'px';
    requestAnimationFrame(()=>{
      el.style.transition = 'height .45s cubic-bezier(.2,0,0,1)';
      el.style.height = targetH + 'px';
      const onEnd = (ev)=>{
        if(ev.propertyName==='height'){
          el.style.transition = '';
          el.style.height = 'auto';
          el.removeEventListener('transitionend', onEnd);
          resolve();
        }
      };
      el.addEventListener('transitionend', onEnd);
    });
  });
}

function showError(msg){
  loginError.innerHTML = '<div class="error-box">'+msg+'</div>';
}

/* ===== åˆå§‹åŒ–ç­ç´šä¸‹æ‹‰ ===== */
(function initClasses(){
  Object.keys(classData).sort().forEach(c=>{
    const opt=document.createElement('option'); opt.value=c; opt.textContent=c; classSel.appendChild(opt);
  });
})();

classSel.addEventListener('change', ()=>{
  const cls=classSel.value;
  nameSel.innerHTML='<option value="">è«‹é¸æ“‡</option>';
  nameSel.disabled=!cls;
  if(!cls) return;
  (classData[cls]||[]).forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; nameSel.appendChild(opt);
  });
  pw.value=''; loginError.innerHTML='';
});

function authenticate(cls, name, pass){
  if(!cls || !name || !pass) return false;
  if(!STRICT_LOGIN) return true;
  if(NONEMPTY_AS_PASS) return pass.trim().length>0;
  return false;
}

/* ===== è¿”å›ç™»å…¥ä¸¦æ¸…ç©º ===== */
function returnToLoginClear(){
  classSel.value = "";
  nameSel.innerHTML = '<option value="">è«‹å…ˆé¸ç­ç´š</option>';
  nameSel.disabled = true;
  pw.value = "";
  loginError.innerHTML = "";
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=""; $('studentName').value="";
  prevBox.classList.add('hidden');
  lastTime.textContent = "";
  responseForm.classList.add('invisible');
  successBox.classList.add('hidden');
  welcome.classList.remove('hidden'); welcome.classList.remove('show');
  noteText.classList.remove('hidden'); noteText.classList.remove('show');
  skeleton.classList.add('hidden');
  bodyWrap.style.height='0px';
  formCard.classList.add('hidden');
  loginCard.classList.remove('hidden');
  // é‚„åŸç™½æ¡†å°ºå¯¸
  formCard.style.width = '';
  formCard.style.height = '';
}

/* ===== é€²å…¥å¡«å¯«å¡ä¸¦è¼‰å…¥è³‡æ–™ï¼ˆå«å‹•ç•«æµç¨‹ï¼‰ ===== */
async function proceed(cls, name){
  // åˆ‡é 
  loginCard.classList.add('hidden');
  formCard.classList.remove('hidden');

  // éšæ®µ A-1ï¼šç™½æ¡†æ”¶çª„åˆ°å¯å®¹ç´æ¨™é¡Œ
  const titleText = `${name} åŒå­¸ä½ å¥½ï¼è«‹å‹¾é¸æ¬²è‡ªä¸»ç·´ç¿’çš„å¤©æ•¸`;
  const titleWidth = measureTitleWidth(titleText) + (parseInt(getComputedStyle(formCard).paddingLeft)||20) + (parseInt(getComputedStyle(formCard).paddingRight)||20) + (2*parseInt(getComputedStyle(formCard).borderLeftWidth||0)) + 2*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--title-safe')||24);
  const targetW = Math.max(Math.min(titleWidth, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-maxw')||760)), parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-minw')||320));
  welcome.textContent = titleText;
  welcome.classList.remove('show');           // clip ç‹€æ…‹åˆå§‹
  formCard.style.width = formCard.getBoundingClientRect().width + 'px'; // é–ç•¶å‰å¯¬
  await nextFrame();
  formCard.style.width = targetW + 'px';      // æ”¶çª„
  await onTransitionEnd(formCard, 'width');

  // éšæ®µ A-2ï¼šæ¨™é¡Œæ“¦å…¥
  welcome.classList.add('show');

  // éª¨æ¶é–‹å•Ÿ + é è¨­ç‹€æ…‹
  skeleton.classList.remove('hidden');
  bodyWrap.style.overflow='hidden';
  bodyWrap.style.height = skeleton.offsetHeight + 'px';
  ['tue','thu','fri'].forEach(id=>$(id).checked=false);
  $('studentClass').value=cls; $('studentName').value=name;
  prevBox.classList.add('hidden');
  responseForm.classList.add('invisible');
  successBox.classList.add('hidden');
  noteText.classList.remove('hidden'); noteText.classList.remove('show');

  // æŸ¥è©¢æ­·å²
  let hasPrev=false;
  try{
    const url = scriptURL + '?class=' + encodeURIComponent(cls) + '&name=' + encodeURIComponent(name);
    const res = await fetch(url, {method:'GET'});
    const data = await res.json();
    if(data && data.ok && data.data){
      const rec = data.data;
      const tue = rec['é€±äºŒ']==='âœ“', thu = rec['é€±å››']==='âœ“', fri = rec['é€±äº”']==='âœ“';
      $('tue').checked = tue; $('thu').checked = thu; $('fri').checked = fri;
      const days = []; if(tue) days.push('é€±äºŒ'); if(thu) days.push('é€±å››'); if(fri) days.push('é€±äº”');
      const summary = days.length ? 'ç™»è¨˜çµæœç‚º' + days.join('ã€') : 'ä¸Šæ¬¡æœªå‹¾é¸ä»»ä½•ä¸€å¤©';
      prevTitle.textContent = 'å·²æ‰¾åˆ°ä½ ä¸Šæ¬¡é€å‡ºçš„ç´€éŒ„ï¼Œ' + summary;
      lastTime.textContent = rec.timestamp ? ('ä¸Šæ¬¡å¡«å¯«æ™‚é–“ï¼š' + rec.timestamp) : '';
      prevBox.classList.remove('hidden');
      hasPrev = true;
    }
  }catch(e){ console.warn('prefill failed', e); }

  // éšæ®µ Bï¼šç™½æ¡†å±•é–‹åˆ°å…§å®¹é«˜åº¦ï¼Œä¸¦éšæ¢¯æ·¡å…¥
  skeleton.classList.add('hidden');
  if(!hasPrev){
    responseForm.classList.remove('invisible');
    choicesWrap.classList.remove('show'); btnWrap.classList.remove('show');
  }
  await animateHeightToContent(bodyWrap);

  // æ·¡å…¥é¡¯ç¤ºï¼ˆå«å°å­—ï¼‰
  const items = Array.from(document.querySelectorAll('#choicesWrap .checkbox-item'));
  // éšæ¢¯å‹•ç•«
  for(let i=0;i<items.length;i++){
    items[i].style.opacity=0; items[i].style.transform='translateY(-4px)';
    setTimeout(()=>{
      items[i].style.transition='opacity .24s ease, transform .24s ease';
      items[i].style.opacity=1; items[i].style.transform='none';
    }, 60*i);
  }
  btnWrap.classList.add('show');
  await nextFrame();
  noteText.classList.add('show');
}

/* ===== äº‹ä»¶ç¶å®š ===== */
loginForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const cls=classSel.value, name=nameSel.value, pass=pw.value;
  if(!authenticate(cls, name, pass)){
    showError('è«‹ç¢ºèªç­ç´šã€å§“åï¼Œä¸¦è¼¸å…¥æ­£ç¢ºå¯†ç¢¼ï¼ˆç›®å‰éç©ºå³å¯ï¼‰');
    return;
  }
  proceed(cls, name);
});

// ä¸ä¿®æ”¹ â†’ è¿”å›ç™»å…¥
btnKeep.addEventListener('click', returnToLoginClear);
// æˆ‘è¦ä¿®æ”¹ â†’ é¡¯ç¤ºè¡¨å–®ä¸¦æ‹‰ä¼¸
btnEdit.addEventListener('click', async ()=>{
  prevBox.classList.add('hidden');
  responseForm.classList.remove('invisible');
  await animateHeightToContent(bodyWrap);
});

btnBack.addEventListener('click', returnToLoginClear);
btnReturnAfterSuccess.addEventListener('click', returnToLoginClear);

/* ===== é€å‡º ===== */
responseForm.addEventListener('submit', async (e)=>{
  e.preventDefault();

  // è‡³å°‘å‹¾ä¸€å€‹
  const t=$('tue').checked, h=$('thu').checked, f=$('fri').checked;
  if(!t && !h && !f){ alert('è«‹è‡³å°‘å‹¾é¸ä¸€å¤©ï¼ˆé€±äºŒï¼é€±å››ï¼é€±äº”ï¼‰'); return; }

  const btn = document.getElementById('btnSubmit'); const txt = btn.querySelector('.btn-text');
  const old = txt.textContent; btn.disabled=true; txt.textContent='é€å‡ºä¸­â€¦';
  try{
    const fd = new FormData(responseForm);
    const res = await fetch(scriptURL, { method:'POST', body: fd });
    if(!res.ok) throw new Error('network');

    // åˆ‡æ›åˆ°æˆåŠŸç•«é¢
    $('welcomeMessage').classList.remove('show'); // éš±è—æ¨™é¡Œæ“¦å…¥
    noteText.classList.remove('show');
    prevBox.classList.add('hidden');
    responseForm.classList.add('invisible');
    successBox.classList.remove('hidden');

    // ç™½æ¡†ç¸®æˆæ­£æ–¹å½¢
    // å…ˆé–å®šç›®å‰é«˜åº¦ï¼Œé¿å…ç›´æ¥è·³è®Š
    const nowW = formCard.getBoundingClientRect().width;
    const nowH = formCard.getBoundingClientRect().height;
    formCard.style.width = nowW + 'px';
    formCard.style.height = nowH + 'px';
    await nextFrame();
    formCard.style.width = getComputedStyle(document.documentElement).getPropertyValue('--square-size').trim();
    formCard.style.height = getComputedStyle(document.documentElement).getPropertyValue('--square-size').trim();

    // æˆåŠŸåœ–ç¤ºæ·¡å…¥
    successImg.classList.remove('show');
    requestAnimationFrame(()=>successImg.classList.add('show'));
  }catch(err){
    alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    btn.disabled=false; txt.textContent=old;
  }
});
</script>
</body>
</html>
